<!DOCTYPE html>
<html lang="en">
<head>
    <!-- META TAGS: Basic page information -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - PayrollPro</title>
    
    <!-- STYLESHEETS: Link to simple CSS -->
    <link rel="stylesheet" href="simple_styles.css">
</head>
<body>
    <!-- LOGIN PAGE CONTAINER: Full-height container for centering the form -->
    <div class="form-container">
        <!-- LOGIN FORM BOX: Centered box with border and shadow -->
        <div class="form-box">
            <!-- FORM HEADER: Title and description -->
            <h2 class="form-title">Login to PayrollPro</h2>
            <p class="text-center" style="color: #6c757d; margin-bottom: 30px;">
                Sign in to access your dashboard
            </p>
            
            <!-- ALERT CONTAINER: For showing success/error messages -->
            <div id="alertContainer"></div>
            
            <!-- LOGIN FORM: Main form for user authentication -->
            <form id="loginForm">
                <!-- USERNAME INPUT: User's login username -->
                <div class="form-group">
                    <label for="username">Username</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        class="form-control" 
                        placeholder="Enter your username"
                        required
                    >
                </div>
                
                <!-- PASSWORD INPUT: User's password -->
                <div class="form-group">
                    <label for="password">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="form-control" 
                        placeholder="Enter your password"
                        required
                    >
                </div>
                
                <!-- ROLE SELECTION: Choose user role (Admin, HR, Director) -->
                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" name="role" class="form-select" required>
                        <option value="">Select your role</option>
                        <option value="Admin">Administrator</option>
                        <option value="HR">HR Manager</option>
                        <option value="Director">Director</option>
                    </select>
                </div>
                
                <!-- SUBMIT BUTTON: Login button -->
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="loginBtn">
                    Login
                </button>
            </form>
            
            <!-- FORM FOOTER: Link to signup page -->
            <div class="form-footer">
                <p>Don't have an account? <a href="signup.html">Sign up here</a></p>
                <p><a href="index.html">‚Üê Back to Home</a></p>
                <div style="margin-top: 15px;">
                    <button type="button" onclick="clearSession()" class="btn btn-outline" style="font-size: 12px; padding: 5px 10px;">
                        Clear Previous Session
                    </button>
                </div>
            </div>
            
            <!-- DEMO CREDENTIALS: Show test credentials for easy testing -->
            <div style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                <h4 style="margin-bottom: 15px; color: #495057; font-size: 16px;">Demo Credentials:</h4>
                <div style="font-size: 14px; color: #6c757d;">
                    <p><strong>Admin:</strong> admin / admin123</p>
                    <p><strong>HR:</strong> hr_manager / hr123</p>
                    <p><strong>Director:</strong> director / director123</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT: Handle form submission and authentication -->
    <script>
        // LOGIN FORM HANDLER: Process login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevent default form submission
            
            // Get form elements
            const loginBtn = document.getElementById('loginBtn');
            const alertContainer = document.getElementById('alertContainer');
            
            // Get form data
            const formData = new FormData(e.target);
            const loginData = {
                username: formData.get('username'),
                password: formData.get('password'),
                role: formData.get('role')
            };
            
            // Show loading state
            loginBtn.textContent = 'Logging in...';
            loginBtn.disabled = true;
            
            // Clear any previous alerts
            alertContainer.innerHTML = '';
            
            try {
                const response = await fetch('http://127.0.0.1:8000/auth/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: loginData.username,
                        password: loginData.password
                    })
                });

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server did not return JSON. Check backend URL and server status.');
                }

                const data = await response.json();

                if (response.ok && data.token) {
                    // Store user info and token
                    localStorage.setItem('user', JSON.stringify({
                        username: data.username,
                        role: data.role,
                        user_id: data.user_id,
                        token: data.token,
                        loginTime: new Date().toISOString()
                    }));
                    localStorage.setItem('token', data.token);

                    alertContainer.innerHTML = `
                        <div class="alert alert-success">
                            Login successful! Redirecting to ${data.role} dashboard in 3 seconds...
                        </div>
                    `;

                    setTimeout(() => {
                        switch(data.role) {
                            case 'Admin':
                                window.location.href = 'dashboard_admin_new.html';
                                break;
                            case 'HR':
                                window.location.href = 'dashboard_hr_new.html';
                                break;
                            case 'Director':
                                window.location.href = 'dashboard_director_new.html';
                                break;
                            default:
                                window.location.href = 'dashboard_admin_new.html';
                        }
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Invalid username or password');
                }
            } catch (error) {
                alertContainer.innerHTML = `
                    <div class="alert alert-error">
                        Login failed: ${error.message}. Please check your credentials and try again.
                    </div>
                `;
                loginBtn.textContent = 'Login';
                loginBtn.disabled = false;
            }
        });
        
        // CHECK IF ALREADY LOGGED IN: Only redirect if explicitly requested
        // Comment out automatic redirect to allow fresh login attempts
        /*
        const currentUser = localStorage.getItem('user');
        if (currentUser) {
            const user = JSON.parse(currentUser);
            console.log('User already logged in:', user);
            
            // Redirect to appropriate dashboard
            switch(user.role) {
                case 'Admin':
                    window.location.href = 'dashboard_admin_new.html';
                    break;
                case 'HR':
                    window.location.href = 'dashboard_hr_new.html';
                    break;
                case 'Director':
                    window.location.href = 'dashboard_director_new.html';
                    break;
            }
        }
        */
        
        // Function to clear previous login session
        function clearSession() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            localStorage.removeItem('loginTime');
            
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-info">
                    Previous session cleared. You can now login fresh.
                </div>
            `;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 3000);
        }
        
        // DEBUGGING: Log page load
        console.log('Login page loaded successfully');
    </script>
</body>
</html>
